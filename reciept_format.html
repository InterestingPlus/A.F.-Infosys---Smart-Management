<!DOCTYPE html>
<html lang="gu">
  <head>
    <meta charset="UTF-8" />
    <title>Receipt Format PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: sans-serif;
        font-weight: 500;
      }

      body {
        padding: 20px;
        background: #f7f7f7;
      }

      .pdf-container {
        padding: 30px;
        background-color: #fff;
        width: 100%;
        max-width: 750px;
        margin: auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }

      h3 {
        font-size: 1.6rem;
      }

      table {
        width: 100%;
        border: 1.5px solid black;
        border-collapse: collapse;
      }

      table,
      th,
      td {
        border: 2px solid black;
        padding: 4px 8px;
        font-size: 1.9rem;
      }

      th {
        font-weight: 500;
      }

      .background {
        background: lightgrey;
      }

      button {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #115e59;
        color: white;
        font-size: 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .left {
        text-align: left;
      }

      .bold {
        font-weight: 600;
      }

      .weak {
        font-size: 1.6rem;
      }

      .center {
        text-align: center;
      }

      .right {
        text-align: right;
      }
      .right > td[colspan="2"] {
        text-align: left;
      }

      .fit-width {
        display: flex;
        flex-direction: column;
        align-items: start;
        justify-content: center;
        min-width: fit-content;
      }
      .fit-width span {
        white-space: nowrap;
      }

      .middle-table,
      .middle-table th,
      .middle-table td {
        border-collapse: collapse;
        border: 0;
      }
      .middle-table {
        border-left: 2px solid black;
        border-right: 2px solid black;
      }
      .middle-table tr {
        border-bottom: 1px solid black;
      }
      .middle-table tr:last-child {
        border-bottom: 0 !important;
      }

      button:hover {
        background-color: #0f766e;
      }
    </style>
  </head>
  <body>
    <button onclick="downloadPDF()">ЁЯУД Download Receipt PDF</button>

    <div id="pdf-content" class="pdf-container">
      <table>
        <tr>
          <th colspan="5" class="bold">
            <span class="bold village-name"></span> ркЧрлНрк░рк╛ркорккркВркЪрк╛ркпркд <br />
            рккркВркЪрк╛ркпркд рк╣рк┐рк╕рк╛ркм ркирк╛ ркиркорлВркирк╛ркирлЛ ркХрлНрк░ркорк╛ркВркХ - рлк <br />
            ркдркмркжрлАрк▓ рки ркХрк░рлА рк╢ркХрк╛ркп ркдрлЗрк╡рлА ркЕрк╕рк▓ рккрк╣рлЛркВркЪ (ркЬрлБркУ ркирк┐ркпрко - рлл)
            <p style="font-size: 1.5rem" class="bold">
              ркдрк╛рк▓рлБркХрлЛ: <span class="bold" id="taluka"></span> ркЬрк┐рк▓рлНрк▓рлЛ:
              <span class="bold" id="district"></span>
            </p>
          </th>
          <h3>(ркЧрлНрк░рк╛рк╣ркХ ркХрлЛрккрлА)</h3>
        </tr>
      </table>

      <table class="middle-table">
        <tr>
          <td class="left fit-width">
            <span>рк╢рлНрк░рлАркорк╛рки /рк╢рлНрк░рлАркоркдрлА :</span>
          </td>
          <td>
            <span class="bold" id="name"></span>
          </td>
        </tr>
        <tr>
          <td class="left fit-width">
            <span>ркХркмрлНркЬрлЗркжрк╛рк░ :</span>
          </td>
          <td>
            <span class="bold" id="owner_name"></span>
          </td>
        </tr>
        <tr>
          <td class="left fit-width">
            <span>рк╕рк░ркирк╛ркорлБркВ :</span>
          </td>
          <td>
            <span class="bold" id="address"></span>
          </td>
        </tr>
      </table>

      <table>
        <tr>
          <td class="left weak" colspan="5">
            ркдрк░рклркерлА рк╕ркирлЗ.<span id="valuationYear"></span> ркирк╛ рк╡рк░рлНрк╖ркорк╛ркВ рк╡рлЗрк░рлЛ/ркмрлАркЬрк╛
            ркирк╛ркгрк╛ркВ рккрлЗркЯрлЗ рк░ркХрко ркорк│рлА ркЫрлЗ.
          </td>
        </tr>

        <tr>
          <th class="bold weak center">ркорк┐рк▓ркХркд ркиркВркмрк░</th>
          <th class="bold weak center">ркЬрлВркирлЛ ркорк┐. ркиркВ.</th>
          <th class="bold weak center">рккрк╣рлЛркВркЪ ркиркВркмрк░</th>
          <th class="bold weak center">рккрк╣рлЛркВркЪ ркдрк╛рк░рлАркЦ</th>
          <th class="bold weak center">рк╡рк┐ркЧркд</th>
        </tr>
        <tr>
          <td class="center" id="milkat_number"></td>
          <td class="center" id="old_milkat_number"></td>
          <td class="center" id="receipt_number"></td>
          <td class="center" id="receipt_date"></td>
          <td class="center" id="payment_type">рк░рлЛркХркб</td>
        </tr>
      </table>

      <table>
        <tr class="background">
          <th colspan="2" rowspan="2" class="background bold">рк╡рлЗрк░рк╛ркирлБркВ ркирк╛рко</th>
          <th colspan="3" class="bold">рк╡рк╕рлБрк▓ ркХрк░рлЗрк▓рлА рк░ркХрко</th>
        </tr>
        <tr>
          <th class="background bold">ркЪрк╛рк▓рлБ ркмрк╛ркХрлА</th>
          <th class="background bold">рккрк╛ркЫрк▓рлА ркмрк╛ркХрлА</th>
          <th class="background bold">ркХрлБрк▓</th>
        </tr>

        <tr class="right">
          <td colspan="2">ркШрк░рк╡рлЗрк░рлЛ</td>
          <td id="houseTax">0</td>
          <td id="houseTaxPrevYear">0</td>
          <td id="houseTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">рк╕рк╛.рккрк╛ркгрлА рк╡рлЗрк░рлЛ</td>
          <td id="saPaTax">0</td>
          <td id="saPaTaxPrevYear">0</td>
          <td id="saPaTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркЦрк╛.рккрк╛ркгрлА рк╡рлЗрк░рлЛ</td>
          <td id="specialWaterTax">0</td>
          <td id="specialWaterTaxPrevYear">0</td>
          <td id="specialWaterTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">рк▓рк╛ркИркЯрк╡рлЗрк░рлЛ</td>
          <td id="lightTax">0</td>
          <td id="lightTaxPrevYear">0</td>
          <td id="lightTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">рк╕рклрк╛ркИ рк╡рлЗрк░рлЛ</td>
          <td id="cleaningTax">0</td>
          <td id="cleaningTaxPrevYear">0</td>
          <td id="cleaningTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркЧркЯрк░ рк╡рлЗрк░рлЛ</td>
          <td id="sewerTax">0</td>
          <td id="sewerTaxPrevYear">0</td>
          <td id="sewerTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркирлЛркЯрлАрк╕</td>
          <td id="noticeFee">0</td>
          <td id="noticeFeePrevYear">0</td>
          <td id="noticeFeeTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркПркбрк╡рк╛ркирлНрк╕</td>
          <td id="advance">0</td>
          <td id="advancePrevYear">0</td>
          <td id="advanceTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">рк╡рлНркпрк╡рк╕рк╛ркп рк╡рлЗрк░рлЛ</td>
          <td id="businessTax">0</td>
          <td id="businessTaxPrevYear">0</td>
          <td id="businessTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркЗркорк▓рк╛ рк╡рлЗрк░рлЛ</td>
          <td id="buildingTax">0</td>
          <td id="buildingTaxPrevYear">0</td>
          <td id="buildingTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">рк╢рлА .ркЙ</td>
          <td id="educationTax">0</td>
          <td id="educationTaxPrevYear">0</td>
          <td id="educationTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркЬ , ркорлЗркВ</td>
          <td id="landTax">0</td>
          <td id="landTaxPrevYear">0</td>
          <td id="landTaxTotal">0</td>
        </tr>
        <tr class="right">
          <td colspan="2">ркЕркирлНркпрлл</td>
          <td id="talukaTax">0</td>
          <td id="talukaTaxPrevYear">0</td>
          <td id="talukaTaxTotal">0</td>
        </tr>
        <tr class="background">
          <th colspan="2" class="bold">ркХрлБрк▓</th>
          <th class="bold right" id="CurrentTotal">00.00</th>
          <th class="bold right" id="PreviousTotal">00.00</th>
          <th class="bold right" id="Total">00.00</th>
        </tr>

        <tr>
          <td colspan="5">
            ркХрлБрк▓ рк░рлВрккрк┐ркпрк╛ рк╢ркмрлНркжрлЛркорк╛ркВ : <span id="totalInWords"></span>
          </td>
        </tr>
        <tr>
          <td colspan="5">ркЪрлЗркХркерлА ркорк│рлЗрк▓ ркирк╛ркгрк╛ркВ рк╡рк╕рлБрк▓рк╛ркдркирлЗ ркЖркзрлАрки ркЫрлЗ</td>
        </tr>
        <tr>
          <td colspan="5">ркмрлЗркирлНркХркирлБркВ ркирк╛рко/ рк╢рк╛ркЦрк╛ / ред ркЪрлЗркХ ркиркВркмрк░ / ркдрк╛рк░рлАркЦ 0/</td>
        </tr>
      </table>

      <div
        style="
          border: 2px solid black;
          padding: 10px;
          font-family: 'Noto Sans Gujarati', 'Shruti', sans-serif;
          font-size: 19px;
          line-height: 1.8;
          margin-top: 1rem;
        "
      >
        ркирлЛркВркз : ркирлАркЪрлЗркирк╛ркВ рк╢рк░ркдрлЛркирлЗ ркЖркзрк┐рки рк╡рлЗрк░рлЛ рк╕рлНрк╡рлАркХрк╛рк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркЫрлЗ.<br />
        (рлз) ркХрлЛркЗрккркг ркорк┐рк▓ркХркдркирлА ркЖркХрк╛рк░ркгрлА ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ рк╣ркХрлНркХ ркЕркВркЧрлЗ ркЪрлЛркХрк╕рк╛ркИркерлА ркеркдрлА ркиркерлА ркорк╛ркдрлНрк░ рк╡рлЗрк░рк╛
        ркЙркШрк░рк╛рк╡рк╛ рккрлВрк░ркдрлА ркЬ ркЖркХрк╛рк░ркгрлА ркХрк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркЫрлЗ.<br />
        (рли) ркЖ рк╕рлВркЪрк┐ркд рк╕рлЛрк╕рк╛ркпркЯрлА рк╣рлЛркп ркЖ ркнрк░рлЗрк▓ рк╡рлЗрк░рк╛ркерлА ркЖ ркЬркорлАрки ркЯрк╛ркЗркЯрк▓ ркХрк▓рлАркпрк░ ркеркдрлА ркиркерлА.<br />
        (рлй) ркЖ рккрлЗркЯрлЗркерлА ркнрк░рлЗрк▓ рк╡рлЗрк░рк╛ркирлА ркЬркорлАркиркирлЛ ркорк╛рк▓рк┐ркХрлА рк╣ркХрлНркХ рккрлНрк░рк╛рккрлНркд ркеркдрлЛ ркиркерлА.<br />
        (рлк) ркнрк╡рк┐рк╖рлНркпркорк╛ркВ ркмрк┐ркиркоркиркЭрлБрк░ ркмрк╛ркВркзркХрк╛рко ркЧрлЗрк░ркХрк╛ркпркжрлЗ ркмркирлЗ ркдрлНркпрк╛рк░рлЗ рккрлЗркЯрлЗ ркХрлЛркИ ркмркЪрк╛рк╡рк░рлВркк ркмркирк╢рлЗ
        ркирк╣рлАркВ,<br />
        ркдрлЗркоркЬ ркорк╛рк▓рк┐ркХрлА рк╣ркХрлНркХ рккрлНрк░рк╛рккрлНркд ркХрк░рк╡рк╛ ркЕркВркЧрлЗ рк░ркЬрлБ ркХрк░рлА рк╢ркХрк╛ркп ркирк╣рлАркВ.<br />

        <div
          style="text-align: right; margin-top: 20px; font-size: 1.5rem"
          class="bold"
        >
          рк╕рк╣рлА<br />
          <p class="bold">
            ркдрк▓рк╛ркЯрлА ркХрко ркоркВркдрлНрк░рлА
            <span class="bold village-name" style="font-size: 1.55rem"></span>
            ркЧрлНрк░рк╛ркорккркВркЪрк╛ркпркд
          </p>
        </div>
      </div>
    </div>

    <script>
      /**
       * Maps HTML element IDs to their corresponding column index in the Google Sheet.
       * This is the central configuration for populating the receipt.
       * Update the index numbers here if your Google Sheet columns change.
       */
      const headerMap = {
        // Top Section
        name: 1,
        valuationYear: 2,
        owner_name: 3,
        address: 4,
        milkat_number: 5,
        old_milkat_number: 6,
        // Assuming taluka and district might be the same as village or fetched from elsewhere.
        // If they are in the sheet, add them here. For now, let's assume they are static or derived.
        // receipt_number and receipt_date would likely be generated or come from another source.
        // Let's assume they are in the sheet for this example.
        receipt_number: 0, // Placeholder
        receipt_date: 15, // Using resolutionDate as receipt_date

        // Current Year Taxes
        houseTax: 19,
        saPaTax: 20,
        specialWaterTax: 21,
        lightTax: 22,
        cleaningTax: 23,
        talukaTax: 24,

        // Previous Year Taxes (assuming these are in subsequent columns)
        houseTaxPrevYear: 25,
        saPaTaxPrevYear: 26,
        specialWaterTaxPrevYear: 27,
        lightTaxPrevYear: 28,
        cleaningTaxPrevYear: 29,
        talukaTaxPrevYear: 30,
      };

      // Configuration for static data (can also be fetched)
      const STATIC_DATA = {
        village: "ркорлЗркШрк░ркЬ",
        taluka: "ркорлЗркШрк░ркЬ",
        district: "ркЕрк░рк╡рк▓рлНрк▓рлА",
      };

      function downloadPDF() {
        const element = document.getElementById("pdf-content");
        const opt = {
          margin: [0.05, 0.05, 0.05, 0.05],
          filename: "Receipt_Report.pdf",
          image: { type: "jpeg", quality: 1.0 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "px", format: "a4", orientation: "portrait" },
          pagebreak: { mode: ["avoid-all"] },
        };
        html2pdf().set(opt).from(element).save();
      }

      async function fetchDataFromSheet(sheetId, recordId) {
        // In Google Sheets, header is row 1, data starts from row 2.
        // So, we fetch row `recordId + 1`.
        const range = `A${recordId + 3}:AZ${recordId + 3}`;
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&range=${range}`;

        console.log(`Fetching from URL: ${url}`);
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`Network response was not ok: ${res.statusText}`);
        }
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));

        if (!json.table.rows || json.table.rows.length === 0) {
          throw new Error(`Record with ID '${recordId}' not found.`);
        }

        const record = json.table.rows[0].c.map((cell) => (cell ? cell.v : ""));
        console.log("Fetched Record:", record);
        return record;
      }

      function safeNumber(val) {
        const num = parseFloat(val);
        return isNaN(num) ? 0 : num;
      }

      function numberToGujaratiWords(num) {
        if (num === 0) return "рк╢рлВркирлНркп рк░рлВрккрк┐ркпрк╛ рккрлБрк░рк╛";
        const units = [
            "",
            "ркПркХ",
            "ркмрлЗ",
            "ркдрлНрк░ркг",
            "ркЪрк╛рк░",
            "рккрк╛ркВркЪ",
            "ркЫ",
            "рк╕рк╛ркд",
            "ркЖрка",
            "ркирк╡",
            "ркжрк╕",
            "ркЕркЧрк┐ркпрк╛рк░",
            "ркмрк╛рк░",
            "ркдрлЗрк░",
            "ркЪрлМркж",
            "рккркВркжрк░",
            "рк╕рлЛрк│",
            "рк╕ркдрлНркдрк░",
            "ркЕркврк╛рк░",
            "ркУркЧркгрлАрк╕",
          ],
          tens = [
            "",
            "",
            "рк╡рлАрк╕",
            "ркдрлНрк░рлАрк╕",
            "ркЪрк╛рк│рлАрк╕",
            "рккркЪрк╛рк╕",
            "рк╕рк╛ркВрка",
            "рк╕рк┐ркдрлНркдрлЗрк░",
            "ркПркВрк╕рлА",
            "ркирлЗрк╡рлБркВ",
          ];

        function toWords(n) {
          if (n < 20) return units[n];
          if (n < 100)
            return (
              tens[Math.floor(n / 10)] +
              (n % 10 !== 0 ? " " + units[n % 10] : "")
            );
          if (n < 1000)
            return (
              units[Math.floor(n / 100)] +
              " рк╕рлЛ" +
              (n % 100 !== 0 ? " " + toWords(n % 100) : "")
            );
          if (n < 100000)
            return (
              toWords(Math.floor(n / 1000)) +
              " рк╣ркЬрк╛рк░" +
              (n % 1000 !== 0 ? " " + toWords(n % 1000) : "")
            );
          if (n < 10000000)
            return (
              toWords(Math.floor(n / 100000)) +
              " рк▓рк╛ркЦ" +
              (n % 100000 !== 0 ? " " + toWords(n % 100000) : "")
            );
          return (
            toWords(Math.floor(n / 10000000)) +
            " ркХрк░рлЛркб" +
            (n % 10000000 !== 0 ? " " + toWords(n % 10000000) : "")
          );
        }
        return toWords(Math.floor(num)) + " рк░рлВрккрк┐ркпрк╛ рккрлБрк░рк╛";
      }

      function populateReceipt(record) {
        // --- 1. Populate direct fields from headerMap ---
        for (const id in headerMap) {
          const element = document.getElementById(id);
          const columnIndex = headerMap[id];
          if (element && record[columnIndex] !== undefined) {
            element.textContent = record[columnIndex];
          }
        }

        // --- Populate static/repeated fields ---
        document
          .querySelectorAll(".village-name")
          .forEach((el) => (el.textContent = STATIC_DATA.village));
        document.getElementById("taluka").textContent = STATIC_DATA.taluka;
        document.getElementById("district").textContent = STATIC_DATA.district;

        // --- 2. Perform Calculations ---
        const taxFields = [
          "houseTax",
          "saPaTax",
          "specialWaterTax",
          "lightTax",
          "cleaningTax",
          "talukaTax",
          "sewerTax",
          "noticeFee",
          "advance",
          "businessTax",
          "buildingTax",
          "educationTax",
          "landTax",
        ];

        let currentTotal = 0;
        let previousTotal = 0;

        taxFields.forEach((field) => {
          const currentVal = safeNumber(
            document.getElementById(field)?.textContent || "0"
          );
          const prevVal = safeNumber(
            document.getElementById(`${field}PrevYear`)?.textContent || "0"
          );
          const total = currentVal + prevVal;

          currentTotal += currentVal;
          previousTotal += prevVal;

          // --- 3. Update Calculated UI Fields (row totals) ---
          const totalElement = document.getElementById(`${field}Total`);
          if (totalElement) {
            totalElement.textContent = total.toFixed(2);
          }
        });

        const grandTotal = currentTotal + previousTotal;

        // --- 4. Update Grand Totals and Amount in Words ---
        document.getElementById("CurrentTotal").textContent =
          currentTotal.toFixed(2);
        document.getElementById("PreviousTotal").textContent =
          previousTotal.toFixed(2);
        document.getElementById("Total").textContent = grandTotal.toFixed(2);
        document.getElementById("totalInWords").textContent =
          numberToGujaratiWords(grandTotal);
      }

      // --- Main execution block that runs on page load ---
      (async function () {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const m_id = urlParams.get("m_id");

          if (!m_id) {
            alert("Please provide a record ID in the URL (e.g., ?m_id=2)");
            document.body.innerHTML = `<h1 style="text-align:center; margin-top: 50px;">No Record ID provided.</h1><p style="text-align:center;">Please add <strong>?m_id=YOUR_RECORD_ID</strong> to the end of the URL.</p>`;
            return;
          }

          const recordIdAsNumber = parseInt(m_id, 10);
          if (isNaN(recordIdAsNumber)) {
            throw new Error("Invalid Record ID. It must be a number.");
          }

          // Your Google Sheet ID
          const sheetId = "1_bs5IQ0kDT_xVLwJdihe17yuyY_UfJRKCtwoGvO7T5Y";
          const record = await fetchDataFromSheet(sheetId, recordIdAsNumber);

          populateReceipt(record);
        } catch (error) {
          console.error("Failed to generate receipt:", error);
          alert(`Error: ${error.message}`);
          document.getElementById(
            "pdf-content"
          ).innerHTML = `<h2 style="color: red; text-align: center;">Failed to load receipt data.</h2><p style="text-align: center;">${error.message}</p>`;
        }
      })();
    </script>
  </body>
</html>
