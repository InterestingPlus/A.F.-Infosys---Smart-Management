<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>A.F. Infosys Dashboard</title>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        min-height: max(884px, 100dvh);
        margin: 0;
      }

      .material-icons {
        font-family: "Material Icons";
        font-weight: normal;
        font-style: normal;
        font-size: 24px;
        display: inline-block;
        line-height: 1;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: normal;
        white-space: nowrap;
        direction: ltr;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
        -moz-osx-font-smoothing: grayscale;
        font-feature-settings: "liga";
      }

      .container {
        /* max-width: 1280px; */
        margin-left: auto;
        margin-right: auto;
        padding: 1rem;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .header h1 {
        font-size: 1.875rem;
        font-weight: 700;
        color: #1d4ed8;
      }

      .header p {
        color: #4b5563;
        margin-top: 0.5rem;
        font-size: 1rem;
      }

      .header .info-row {
        display: flex;
        justify-content: center;
        align-items: center;
        column-gap: 1rem;
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.5rem;
      }

      .header .info-row span {
        white-space: nowrap;
      }

      .panel {
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        padding: 1.5rem;
      }

      .filter-section {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .filter-input-group {
        position: relative;
        flex-grow: 1;
      }

      .filter-input-group .material-icons {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
      }

      .filter-input {
        width: 100%;
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: #1f2937;
        background-color: #ffffff;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }

      .filter-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }

      .filter-dropdown-group {
        position: relative;
      }

      .filter-dropdown {
        display: block;
        width: 100%;
        padding: 0.5rem 2.5rem 0.5rem 1rem;
        background-color: #ffffff;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #1f2937;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        cursor: pointer;
      }

      .filter-dropdown:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
      }

      .filter-dropdown-icon {
        pointer-events: none;
        position: absolute;
        top: 50%;
        right: 0.5rem;
        transform: translateY(-50%);
        color: #4b5563;
      }

      .table-container {
        overflow-x: auto;
      }

      .data-table {
        min-width: 100%;
        border-collapse: collapse;
        border: 1px solid #e5e7eb;
      }

      .data-table thead {
        background-color: #f9fafb;
      }

      .data-table th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #e5e7eb;
      }

      .data-table tbody {
        background-color: #ffffff;
      }

      .data-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
      }

      .data-table tbody tr:last-child {
        border-bottom: none;
      }

      .data-table td {
        padding: 0.75rem 1rem;
        white-space: nowrap;
        font-size: 0.875rem;
        color: #374151;
        border-right: 1px solid #e5e7eb;
      }

      .data-table td:last-child,
      .data-table th:last-child {
        border-right: none;
      }

      /* FIX for desktop table actions */
      .table-actions {
        display: flex;
        gap: 0.5rem; /* Use gap instead of column-gap for consistency */
        flex-wrap: wrap;
        justify-content: center; /* Center buttons within their cell */
        align-items: stretch; /* Make all buttons the same height */
      }

      .action-button {
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center; /* Center content within button */
        border: none;
        cursor: pointer;
        transition-property: background-color, border-color, color, fill, stroke,
          opacity, box-shadow, transform, filter, backdrop-filter;
        transition-duration: 150ms;
        text-decoration: none;
        white-space: nowrap; /* Prevent text wrapping inside buttons */
        flex: 1 1 auto; /* Allow buttons to grow/shrink and wrap */
        min-width: fit-content; /* Ensure they don't shrink too much */
      }

      .action-button .material-icons {
        font-size: 0.875rem;
        margin-right: 0.25rem;
      }

      .action-button img {
        width: 0.75rem;
        height: 0.75rem;
        margin-right: 0.25rem;
      }

      .action-button.view {
        background-color: #dbeafe;
        color: #2563eb;
      }

      .action-button.view:hover {
        background-color: #bfdbfe;
      }

      .action-button.print {
        background-color: #d1fae5;
        color: #059669;
      }

      .action-button.print:hover {
        background-color: #a7f3d0;
      }

      .action-button.send {
        background-color: #ccfbf1;
        color: #0d9488;
      }

      .action-button.send:hover {
        background-color: #99f6e4;
      }

      .footer-text {
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.5rem;
        text-align: right;
        padding-bottom: 0.5rem;
        padding-right: 0.5rem;
      }

      .mobile-panel {
        padding: 1rem;
      }

      .mobile-panel h2 {
        font-size: 1.125rem;
      }

      .mobile-filter-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .mobile-filter-group .filter-input-group,
      .mobile-filter-group .filter-dropdown-group {
        flex-basis: calc(50% - 0.375rem);
        min-width: 150px;
      }

      .mobile-cards-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .mobile-card {
        background-color: #f9fafb;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      .mobile-card .owner-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #2b3543;
      }

      .mobile-card .society-name {
        font-size: 0.75rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
      }

      .mobile-card .grid-info {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 0.5rem;
        font-size: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .mobile-card .grid-info > div {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .mobile-card .grid-info span {
        font-weight: 500;
        color: #4b5563;
      }

      .mobile-card .total-due {
        color: #2563eb;
        font-weight: 600;
      }

      .mobile-card .flex-actions {
        display: flex;
        gap: 0.5rem; /* Use gap for consistency */
        flex-wrap: wrap;
      }

      .mobile-card .flex-actions button,
      .mobile-card .flex-actions a {
        flex: 1 1 0%;
        min-width: 80px;
        padding: 0.375rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        cursor: pointer;
        white-space: nowrap; /* Prevent text wrapping inside buttons */
      }

      .hidden {
        display: none !important;
      }

      .block {
        display: block !important;
      }

      /* --- Loading Spinner CSS --- */
      .loading-overlay {
        position: fixed; /* Covers the entire viewport */
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(
          255,
          255,
          255,
          0.8
        ); /* Semi-transparent white background */
        display: flex; /* Use flexbox for centering */
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        z-index: 9999; /* Ensure it's on top of everything */
        opacity: 0; /* Start hidden with opacity 0 */
        pointer-events: none; /* Allows clicks through when hidden */
        transition: opacity 0.3s ease-out; /* Smooth fade out */
      }

      .loading-overlay.visible {
        opacity: 1; /* Make visible */
        pointer-events: auto; /* Enable clicks/interaction when visible */
      }

      .spinner {
        border: 8px solid #f3f3f3; /* Light grey border */
        border-top: 8px solid #3498db; /* Blue top border (makes it a spinner) */
        border-radius: 50%; /* Make it a circle */
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite; /* Spin animation */
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @media (min-width: 768px) {
        .md\:block {
          display: block !important;
        }

        .md\:hidden {
          display: none !important;
        }

        .filter-input-group {
          flex-basis: 33.333333%;
        }

        .filter-dropdown-group {
          flex-basis: 25%;
        }
      }

      @media (min-width: 640px) {
        .mobile-card .grid-info {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      table tr th {
        font-size: 1.2rem !important;
        background-color: #6e6dad34;
      }
      table .action-column {
        font-size: 0.9rem !important;
      }
      table tr td {
        font-size: 1rem !important;
        text-wrap: wrap;
      }
      table tr:nth-of-type(even) td {
        background: #8579791e;
      }
      table .owner-name {
        max-width: 300px !important;
        text-wrap: wrap;
      }
      table .society-name {
        max-width: 230px !important;
        text-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay" class="loading-overlay">
      <div class="spinner"></div>
    </div>

    <div class="container">
      <header class="header">
        <h1>A.F. Infosys</h1>
        <p>મિલકત પહેંચાની યાદી - વર્ષ : <span>2025-2026</span></p>
        <div class="info-row">
          <span>નામ : HASANPAR</span>
          <span>તાલુકો : Wankaner</span>
          <span>જીલ્લો : MORBI</span>
        </div>
      </header>

      <div class="panel hidden md:block">
        <div class="filter-section">
          <div class="filter-input-group">
            <span class="material-icons">search</span>
            <input
              type="text"
              id="desktopSearch"
              placeholder="માલિકનું નામ અથવા મિલકત નં. શોધો"
              class="filter-input"
              onkeyup="applyFilters()"
            />
          </div>
          <div class="filter-dropdown-group">
            <select
              id="desktopSocietyFilter"
              class="filter-dropdown"
              onchange="applyFilters()"
            >
              <option value="">બધી સોસાયટી</option>
            </select>
            <span class="material-icons filter-dropdown-icon"
              >arrow_drop_down</span
            >
          </div>
          <div class="filter-dropdown-group" style="display: none">
            <select
              id="desktopDueFilter"
              class="filter-dropdown"
              onchange="applyFilters()"
            >
              <option value="">બધા બાકી</option>
              <option value="hasDue">બાકી છે</option>
              <option value="noDue">બાકી નથી</option>
            </select>
            <span class="material-icons filter-dropdown-icon"
              >arrow_drop_down</span
            >
          </div>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th rowspan="2">ક્રમ નં.</th>
                <th rowspan="2">માલિકનું નામ</th>
                <th rowspan="2">સોસાયટીનું નામ</th>
                <th rowspan="2">મોબાઈલ નં.</th>
                <th rowspan="2">મિલકત નં.</th>
                <th rowspan="2">પાછલું બાકી</th>
                <th rowspan="2">ચાલુ બાકી</th>
                <th rowspan="2">કુલ બાકી</th>
                <th colspan="3" class="action-column">Reciept</th>
              </tr>
              <tr>
                <th class="action-column">View</th>
                <th class="action-column">Print</th>
                <th class="action-column">Send</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="panel md:hidden mobile-panel">
        <h2
          style="
            font-size: 1.125rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
          "
        >
          Property List
        </h2>
        <div class="mobile-filter-group">
          <div class="filter-input-group">
            <span class="material-icons">search</span>
            <input
              type="text"
              id="mobileSearch"
              placeholder="શોધો..."
              class="filter-input"
              onkeyup="applyFilters()"
            />
          </div>
          <div class="filter-dropdown-group">
            <select
              id="mobileSocietyFilter"
              class="filter-dropdown"
              onchange="applyFilters()"
            >
              <option value="">સોસાયટી</option>
            </select>
            <span class="material-icons filter-dropdown-icon"
              >arrow_drop_down</span
            >
          </div>
          <div class="filter-dropdown-group" style="display: none">
            <select
              id="mobileDueFilter"
              class="filter-dropdown"
              onchange="applyFilters()"
            >
              <option value="">બાકી</option>
              <option value="hasDue">બાકી છે</option>
              <option value="noDue">બાકી નથી</option>
            </select>
            <span class="material-icons filter-dropdown-icon"
              >arrow_drop_down</span
            >
          </div>
        </div>
        <div class="mobile-cards-container"></div>
        <p class="footer-text">(On Whatsapp)</p>
      </div>
    </div>

    <script>
      let allRecords = []; // Store all fetched records
      let societyNames = new Set(); // Store unique society names
      const loadingOverlay = document.getElementById("loading-overlay"); // Get the loader element

      // Function to show the loading spinner
      function showLoader() {
        loadingOverlay.classList.add("visible");
        loadingOverlay.classList.remove("hidden"); // Ensure hidden is removed
      }

      // Function to hide the loading spinner
      function hideLoader() {
        loadingOverlay.classList.remove("visible");
        // We use CSS transition for opacity, then set display to none
        setTimeout(() => {
          loadingOverlay.classList.add("hidden");
        }, 300); // Matches the CSS transition duration
      }

      async function fetchDataFromSheet(sheetId) {
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows.map((row) =>
          row.c.map((cell) => (cell ? cell.v : ""))
        );
        return rows;
      }

      function safeNumber(val) {
        const num = parseFloat(val);
        return isNaN(num) ? 0 : num;
      }

      function renderTableAndCards(recordsToRender) {
        const desktopTbody = document.querySelector(
          ".panel.hidden.md\\:block table tbody"
        );
        const mobileCardsContainer = document.querySelector(
          ".panel.md\\:hidden .mobile-cards-container"
        );

        // Clear existing content
        if (desktopTbody) desktopTbody.innerHTML = "";
        if (mobileCardsContainer) mobileCardsContainer.innerHTML = "";

        // Add a message if no records are found after filtering
        if (
          recordsToRender.length === 0 ||
          (recordsToRender.length === 1 &&
            recordsToRender[0].originalIndex === 0)
        ) {
          const noResultsMessage =
            '<p style="text-align: center; color: #6b7280; padding: 1rem;">No records found matching your criteria.</p>';
          if (desktopTbody) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 11; // Adjust colspan to match your table columns
            td.innerHTML = noResultsMessage;
            tr.appendChild(td);
            desktopTbody.appendChild(tr);
          }
          if (mobileCardsContainer) {
            mobileCardsContainer.innerHTML = noResultsMessage;
          }
          return; // Exit if no records to render
        }

        recordsToRender.forEach((row, index) => {
          // Skip header row if it's the original index 0
          if (row.originalIndex === 0) return;

          const current =
            safeNumber(row[19]) +
            safeNumber(row[20]) +
            safeNumber(row[21]) +
            safeNumber(row[22]) +
            safeNumber(row[23]) +
            safeNumber(row[24]);

          const previous =
            safeNumber(row[25]) +
            safeNumber(row[26]) +
            safeNumber(row[27]) +
            safeNumber(row[28]) +
            safeNumber(row[29]) +
            safeNumber(row[30]);

          const totalDue = previous + current;
          const milkatId = row.originalIndex; // Use original index for unique ID

          // Desktop Table Row
          if (desktopTbody) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${milkatId}</td>
                    <td class="owner-name">${row[1]}</td> 
                    <td class="society-name">${row[4]}</td>
                    <td>${row[17]}</td>
                    <td>${row[5]}</td>
                    <td>${previous === null ? 0 : previous}</td>
                    <td>${current}</td>
                    <td>${totalDue}</td>
                    <td>
                      <a href="reciept_format.html?m_id=${milkatId}" class="action-button view">
                          <span class="material-icons">visibility</span>View
                      </a>
                    </td>
                    <td>
                      <a href="reciept_format.html?m_id=${milkatId}" class="action-button print">
                          <span class="material-icons">print</span>Print
                      </a>
                    </td>
                    <td>
                      <button class="action-button send whatsapp-btn" onclick="sendOnWhatsApp(${milkatId}, this)">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp icon"/> Send
                      </button>
                    </td>`;
            desktopTbody.appendChild(tr);
          }

          // Mobile Card
          if (mobileCardsContainer) {
            const div = document.createElement("div");
            div.className = "mobile-card";
            div.innerHTML = `
                    <div class="mb-2">
                        <p class="owner-name">${row[1]}</p>
                        <p class="society-name">સોસાયટી: ${row[4]}</p>
                    </div>
                    <div class="grid-info">
                        <div><span>મોબાઈલ નં.:</span> ${row[17]}</div>
                        <div><span>મિલકત નં.:</span> ${row[5]}</div>
                        <div><span>પાછલું બાકી:</span> ${
                          previous === null ? 0 : previous
                        }</div>
                        <div><span>ચાલુ બાકી:</span> ${current}</div>
                        <div style="grid-column: span 2 / span 2;"><span>કુલ બાકી:</span> <span class="total-due">${totalDue}</span></div>
                    </div>
                    <div class="flex-actions">
                        <a href="reciept_format.html?m_id=${milkatId}" class="action-button view">
                            <span class="material-icons">visibility</span>View
                        </a>
                        <a href="reciept_format.html?m_id=${milkatId}" class="action-button print">
                            <span class="material-icons">print</span>Print
                        </a>
                        <button class="action-button send whatsapp-btn" onclick="sendOnWhatsApp(${milkatId}, this)">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp icon"/> Send
                        </button>
                    </div>
                `;
            mobileCardsContainer.appendChild(div);
          }
        });
      }

      function populateSocietyFilters() {
        const desktopSelect = document.getElementById("desktopSocietyFilter");
        const mobileSelect = document.getElementById("mobileSocietyFilter");

        societyNames.forEach((name) => {
          const option1 = document.createElement("option");
          option1.value = name;
          option1.textContent = name;
          desktopSelect.appendChild(option1);

          const option2 = document.createElement("option");
          option2.value = name;
          option2.textContent = name;
          mobileSelect.appendChild(option2);
        });
      }

      function applyFilters() {
        const isMobile = window.innerWidth < 768;

        const searchTerm = (
          isMobile
            ? document.getElementById("mobileSearch").value
            : document.getElementById("desktopSearch").value
        ).toLowerCase();
        const selectedSociety = isMobile
          ? document.getElementById("mobileSocietyFilter").value
          : document.getElementById("desktopSocietyFilter").value;
        const selectedDueStatus = isMobile
          ? document.getElementById("mobileDueFilter").value
          : document.getElementById("desktopDueFilter").value;

        const filteredRecords = allRecords.filter((row) => {
          if (row.originalIndex === 0) return false; // Skip the header row from actual filtering

          const ownerName = row[1] ? row[1].toLowerCase() : "";
          const propertyNumber = row[5] ? row[5].toString().toLowerCase() : "";
          const societyName = row[4] ? row[4].toLowerCase() : "";

          const current =
            safeNumber(row[19]) +
            safeNumber(row[20]) +
            safeNumber(row[21]) +
            safeNumber(row[22]) +
            safeNumber(row[23]) +
            safeNumber(row[24]);

          const previous =
            safeNumber(row[25]) +
            safeNumber(row[26]) +
            safeNumber(row[27]) +
            safeNumber(row[28]) +
            safeNumber(row[29]) +
            safeNumber(row[30]);
          const totalDue = previous + current;

          // Search filter
          const matchesSearch =
            ownerName.includes(searchTerm) ||
            propertyNumber.includes(searchTerm);

          // Society filter
          const matchesSociety =
            selectedSociety === "" ||
            societyName === selectedSociety.toLowerCase();

          // Due status filter
          let matchesDueStatus = true;
          if (selectedDueStatus === "hasDue") {
            matchesDueStatus = totalDue > 0;
          } else if (selectedDueStatus === "noDue") {
            matchesDueStatus = totalDue === 0;
          }

          return matchesSearch && matchesSociety && matchesDueStatus;
        });

        renderTableAndCards(filteredRecords);
      }

      (async function () {
        showLoader(); // Show loader when the script starts fetching data

        try {
          const records = await fetchDataFromSheet(
            "1_bs5IQ0kDT_xVLwJdihe17yuyY_UfJRKCtwoGvO7T5Y"
          );

          // const records = [
          //   [
          //     96,
          //     "મધુબેન બાબુભાઈ પરમાર",
          //     "2024-25",
          //     "",
          //     "1-સમદ નગર",
          //     96,
          //     "",
          //     153,
          //     "",
          //     "",
          //     "રહેઠાણ",
          //     20000,
          //     0,
          //     "1 લાઈન",
          //     "પાકા સ્‍લેબવાળા રૂમ-1, રસોડુ, બાથરૂમ",
          //     "Date(2025,1,28)",
          //     "",
          //     "",
          //     "Meghraj- MEGHRAJ",
          //     140,
          //     30,
          //     250,
          //     60,
          //     60,
          //     21,
          //     "",
          //     "",
          //     "",
          //     "",
          //     "",
          //     null,
          //   ],
          //   [
          //     97,
          //     "જીતેન્‍દ્રભાઈ પરમાભાઈ પરમાર",
          //     "2024-25",
          //     "",
          //     "1-સમદ નગર",
          //     97,
          //     "",
          //     153,
          //     "",
          //     "",
          //     "રહેઠાણ",
          //     20000,
          //     0,
          //     "1 લાઈન",
          //     "પાકા સ્‍લેબવાળા રૂમ-1, રસોડુ, બાથરૂમ",
          //     "Date(2025,1,28)",
          //     "",
          //     "",
          //     "Meghraj- MEGHRAJ",
          //     140,
          //     30,
          //     250,
          //     60,
          //     60,
          //     21,
          //     "",
          //     "",
          //     "",
          //     "",
          //     "",
          //     null,
          //   ],
          //   [
          //     98,
          //     "કરશનભાઈ રણછોડભાઈ વણકર",
          //     "2024-25",
          //     "",
          //     "1-સમદ નગર",
          //     98,
          //     "",
          //     153,
          //     "",
          //     "",
          //     "રહેઠાણ",
          //     20000,
          //     0,
          //     "1 લાઈન",
          //     "પાકા સ્‍લેબવાળા રૂમ-1",
          //     "Date(2025,1,28)",
          //     "",
          //     "",
          //     "Meghraj- MEGHRAJ",
          //     140,
          //     30,
          //     250,
          //     60,
          //     60,
          //     21,
          //     105,
          //     30,
          //     250,
          //     60,
          //     60,
          //     16,
          //   ],
          // ];

          console.log(records);

          // Store all records with their original index
          allRecords = records.map((record, index) => ({
            ...record,
            originalIndex: index,
          }));

          // Collect unique society names (starting from index 1 to skip header)
          for (let i = 1; i < allRecords.length; i++) {
            if (allRecords[i][4]) {
              // Column 4 is society name
              societyNames.add(allRecords[i][4]);
            }
          }

          populateSocietyFilters();
          applyFilters(); // Initial render with all data
        } catch (error) {
          console.error("Error fetching data from Google Sheet:", error);
          const errorMessage = `<p style="text-align: center; color: red; padding: 1rem;">Failed to load data. Please try again later.</p>`;
          document.querySelector(
            ".panel.hidden.md\\:block table tbody"
          ).innerHTML = `<tr><td colspan="11">${errorMessage}</td></tr>`;
          document.querySelector(
            ".panel.md\\:hidden .mobile-cards-container"
          ).innerHTML = errorMessage;
        } finally {
          hideLoader(); // Hide loader after data is fetched or an error occurs
        }
      })();

      // --- JAVASCRIPT FUNCTION TO CALL THE BOT ---
      async function sendOnWhatsApp(milkatId, buttonElement) {
        // Provide visual feedback
        const originalText = buttonElement.innerHTML;
        const originalBgColor = buttonElement.style.backgroundColor;
        const originalColor = buttonElement.style.color;

        buttonElement.innerHTML =
          '<span class="material-icons">send</span> Sending...';
        buttonElement.disabled = true;

        // The URL of YOUR bot's server
        const botServerUrl = "http://localhost:4444/send-receipt";

        try {
          const response = await fetch(botServerUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ m_id: milkatId }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            buttonElement.innerHTML =
              '<span class="material-icons">check_circle</span> Sent!';
            buttonElement.style.backgroundColor = "#d1fae5";
            buttonElement.style.color = "#059669";
          } else {
            throw new Error(result.message || "Failed to send.");
          }
        } catch (error) {
          console.error("Error sending WhatsApp message:", error);
          buttonElement.innerHTML =
            '<span class="material-icons">error</span> Error!';
          buttonElement.style.backgroundColor = "#fee2e2";
          buttonElement.style.color = "#ef4444";
          alert("Failed to send WhatsApp message: " + error.message);
        } finally {
          // Optional: Reset button after a few seconds
          setTimeout(() => {
            buttonElement.innerHTML = originalText;
            buttonElement.style.backgroundColor = originalBgColor; // Revert to original color
            buttonElement.style.color = originalColor; // Revert to original color
            buttonElement.disabled = false;
          }, 4000);
        }
      }
    </script>
  </body>
</html>
